<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rep. Ronny Johns - Q3 2025 Constituent Outreach Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"; // Keep this import
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Keep this import for Auth
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Keep this import for Firestore
        // You can remove the getAnalytics import if you don't plan to use it:
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js"; 


        // Global Firebase instances (will be initialized in DOMContentLoaded)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.isAuthReady = false; // Flag to indicate auth state is determined

        // Expose Firestore functions globally
        window.firestoreCollection = collection;
        window.firestoreDoc = doc;
        window.firestoreGetDoc = getDoc;
        window.firestoreSetDoc = setDoc;
        window.firestoreUpdateDoc = updateDoc;
        window.firestoreDeleteDoc = deleteDoc;
        window.firestoreOnSnapshot = onSnapshot;
        window.firestoreQuery = query;
        window.firestoreWhere = where;
        window.firestoreAddDoc = addDoc;
        window.firestoreGetDocs = getDocs;

        document.addEventListener('DOMContentLoaded', async () => {
            // ====================================================================================================================================
            // Your Firebase Configuration has been inserted here.
            // This `appId` string is used to structure your data within Firestore.
            // ====================================================================================================================================
            const appId = 'rep-johns-outreach-app'; // Unique identifier for your app's data in Firestore
            const firebaseConfig = { // Your actual Firebase project configuration
                apiKey: "AIzaSyCd6BQ0vs9VSVBNJWgD0fcMUKqsHDLMCbI",
                authDomain: "rep-johns-constituent-outreach.firebaseapp.com",
                projectId: "rep-johns-constituent-outreach",
                storageBucket: "rep-johns-constituent-outreach.firebasestorage.app",
                messagingSenderId: "22216206687",
                appId: "1:22216206687:web:5c5ae96bceb354f29f6eea",
                measurementId: "G-G7PCJ7M6Q4" // Analytics ID, optional for core functionality
            };
            // The __initial_auth_token variable is specific to the Canvas environment and is not used in general GitHub Pages deployments.
            const initialAuthToken = null; 

            // This check ensures that the Firebase config has valid values.
            if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_FIREBASE_PROJECT_ID") { // Added a more robust check
                console.error("Firebase config is missing or placeholder values are still used. Data persistence will not work.");
                showAppMessage("Error: Firebase is NOT configured. Data will NOT be saved. Please ensure Firebase config is correctly set in the code.", "error", 15000); 
                return;
            }

            // Initialize Firebase
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            // If you want to use analytics, uncomment this:
            // const analytics = getAnalytics(window.firebaseApp);

            // Authentication listener to handle user state changes
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.currentUserId = user.uid;
                    console.log("Authenticated with user ID:", window.currentUserId);
                } else {
                    console.log("No user authenticated. Attempting anonymous sign-in.");
                    try {
                        // For GitHub Pages, anonymous sign-in is the easiest way to get a user ID.
                        await signInAnonymously(window.auth);
                        console.log("Signed in anonymously. User ID:", window.auth.currentUser.uid);
                        window.currentUserId = window.auth.currentUser.uid; 
                    } catch (error) {
                        console.error("Firebase authentication error:", error);
                        showAppMessage(`Authentication failed: ${error.message}. Data may not be saved.`, "error");
                        // Fallback to a random ID if auth fails, so app can still render (without persistence)
                        window.currentUserId = crypto.randomUUID(); 
                    }
                }
                window.isAuthReady = true;
                // Only start listening to data once auth is ready
                setupFirestoreListener(appId); // Pass appId to the listener
            });

            // The rest of the script's core logic (showAppMessage, showConfirmModal,
            // initialRawOutreachData, getChannelIcon, updateItemProperty, updateEditableContent,
            // deleteItem, setupFirestoreListener, renderCalendarGrid, setupFilters,
            // renderKPIs, renderCharts) should be defined below this DOMContentLoaded block
            // but still within the <script> tags. They are global by default in this context.
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active {
            background-color: #1E40AF; /* A deep blue */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-enter {
            animation: card-enter 0.5s ease-out both;
        }
        @keyframes card-enter {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .graphic-needed-highlight {
            background-color: #EDE9FE; /* Light purple */
            border-color: #8B5CF6; /* Purple border */
        }
        /* Style for editable content */
        [contenteditable="true"]:focus {
            outline: 2px solid #3B82F6; /* Blue ring on focus */
            outline-offset: 2px;
            border-radius: 4px; /* Soften the corners */
        }
        .editable-text-field {
            padding: 2px 4px;
            margin: -2px -4px; /* Adjust margin to prevent layout shift */
            display: inline-block; /* Essential for span/p editable */
        }

        /* Custom Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .modal-confirm {
            background-color: #EF4444; /* Red */
            color: white;
        }
        .modal-confirm:hover {
            background-color: #DC2626; /* Darker Red */
        }
        .modal-cancel {
            background-color: #E5E7EB; /* Light Gray */
            color: #374151; /* Dark Gray */
        }
        .modal-cancel:hover {
            background-color: #D1D5DB; /* Darker Light Gray */
        }
        .app-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .app-message.show {
            opacity: 1;
        }
        .app-message.error {
            background-color: #EF4444;
        }
        .app-message.success {
            background-color: #10B981;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <div id="loading-indicator" class="text-center text-xl text-blue-600 font-semibold my-8 hidden">Loading activities...</div>
        <div id="app-message-container"></div>
        <div id="modal-container"></div>
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-2">Rep. Ronny Johns</h1>
            <h2 class="text-xl md:text-2xl text-blue-800 font-semibold">Q3 2025 Constituent Outreach Strategy</h2>
            <p class="max-w-3xl mx-auto mt-4 text-slate-600">
                This dashboard provides an interactive overview of Rep. Johns's Q3 2025 outreach plan, highlighting his work as Chair of the Transportation Committee and his focus on Education. Use the filters to explore planned activities. You can now also link to content, update the status of each outreach item, edit the card's content directly, and **all your changes will now be saved automatically!**
            </p>
            <p id="user-id-display" class="text-sm text-slate-500 mt-2">Loading user ID...</p>
        </header>

        <section id="kpi-section" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12 text-center">
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <aside class="lg:col-span-1 space-y-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4 text-slate-900">Filter Activities</h3>
                    <div id="filters">
                        <div>
                            <label for="week-filter" class="block text-sm font-medium text-slate-700 mb-2">By Week</label>
                            <select id="week-filter" class="w-full p-2 border border-slate-300 rounded-md bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Weeks</option>
                            </select>
                        </div>
                        <div class="mt-6">
                            <h4 class="block text-sm font-medium text-slate-700 mb-2">By Channel</h4>
                            <div id="channel-filters" class="flex flex-wrap gap-2">
                                <button data-filter="all" class="filter-btn active py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">All</button>
                                <button data-filter="Facebook" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">Facebook</button>
                                <button data-filter="Column" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">Column</button>
                                <button data-filter="Press Release" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">Press Release</button>
                                <button data-filter="Indigov" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">Indigov</button>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="block text-sm font-medium text-slate-700 mb-2">By Focus Area</h4>
                            <div id="theme-filters" class="flex flex-wrap gap-2">
                                <button data-filter="all" class="filter-btn active py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">All</button>
                                <button data-filter="Transportation" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">Transportation</button>
                                <button data-filter="Education" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">Education</button>
                                <button data-filter="Community" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">Community</button>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="block text-sm font-medium text-slate-700 mb-2">By Status</h4>
                            <div id="status-filters" class="flex flex-wrap gap-2">
                                <button data-filter="all" class="filter-btn active py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">All</button>
                                <button data-filter="Planned" class="filter-btn py-2 px-4 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">Planned</button>
                                <button data-filter="Scheduled" class="filter-btn py-2 px-4 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium">Scheduled</button>
                                <button data-filter="Completed" class="filter-btn py-2 px-4 bg-green-100 text-green-700 rounded-full text-sm font-medium">Completed</button>
                            </div>
                        </div>
                           <div class="mt-6">
                                <h4 class="block text-sm font-medium text-slate-700 mb-2">Graphic Needed</h4>
                                <div id="graphic-filters" class="flex flex-wrap gap-2">
                                    <button data-filter="all" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">All</button>
                                    <button data-filter="yes" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">Yes</button>
                                    <button data-filter="no" class="filter-btn py-2 px-4 bg-slate-200 text-slate-700 rounded-full text-sm font-medium">No</button>
                                </div>
                           </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4 text-slate-900">Activities by Channel</h3>
                    <div class="chart-container">
                        <canvas id="channelChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="font-bold text-lg mb-4 text-slate-900">Weekly Activity Volume</h3>
                    <div class="chart-container">
                        <canvas id="weeklyActivityChart"></canvas>
                    </div>
                </div>
            </aside>
            
            <section class="lg:col-span-2 min-h-screen">
                 <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Activity cards will be injected here -->
                </div>
            </section>
        </main>
        
        <footer class="text-center mt-12 pt-8 border-t border-slate-200">
            <p class="text-slate-600">This interactive report was generated to provide insight into Rep. Ronny Johns's constituent outreach.</p>
            <p class="text-sm text-slate-500 mt-2">For official inquiries, please contact Rep. Johns's office.</p>
        </footer>
    </div>

    <script>
        // Global Firebase instances (initialized in the module script head)
        // window.firebaseApp, window.db, window.auth, window.currentUserId, window.isAuthReady
        // window.firestoreCollection, window.firestoreDoc, window.firestoreSetDoc, etc.

        let outreachData = []; // This will now be populated from Firestore
        let filters = {
            week: 'all',
            channel: 'all',
            theme: 'all',
            status: 'all',
            graphic: 'all' 
        };

        const calendarGrid = document.getElementById('calendar-grid');
        const weekFilter = document.getElementById('week-filter');
        const channelFilters = document.getElementById('channel-filters');
        const themeFilters = document.getElementById('theme-filters');
        const statusFilters = document.getElementById('status-filters'); 
        const graphicFilters = document.getElementById('graphic-filters'); 
        const kpiSection = document.getElementById('kpi-section');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        const modalContainer = document.getElementById('modal-container');
        const appMessageContainer = document.getElementById('app-message-container');

        // Function to show custom app messages (e.g., for errors or success)
        function showAppMessage(message, type = 'info', duration = 3000) {
            const messageElement = document.createElement('div');
            messageElement.className = `app-message ${type}`;
            messageElement.textContent = message;
            appMessageContainer.appendChild(messageElement);

            setTimeout(() => {
                messageElement.classList.add('show');
            }, 10); // Small delay to trigger transition

            setTimeout(() => {
                messageElement.classList.remove('show');
                messageElement.addEventListener('transitionend', () => messageElement.remove());
            }, duration);
        }

        // Custom Confirmation Modal
        function showConfirmModal(message, onConfirm) {
            modalContainer.innerHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <p>${message}</p>
                        <div class="modal-buttons">
                            <button class="modal-cancel" id="modal-cancel-btn">Cancel</button>
                            <button class="modal-confirm" id="modal-confirm-btn">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.querySelector('#modal-cancel-btn').onclick = () => modalContainer.innerHTML = '';
            modalContainer.querySelector('#modal-confirm-btn').onclick = () => {
                onConfirm();
                modalContainer.innerHTML = '';
            };
        }


        // Raw data to initially populate Firestore if the collection is empty
        const initialRawOutreachData = [
            { week: 1, date: '2025-06-30', channel: 'Press Release', theme: 'Introduction', title: "Rep. Ronny Johns Introduces Himself to HD 25, Highlights Transportation & Education Priorities", description: "Introduces Rep. Johns, celebrates legislative victories, and outlines his commitment as Transportation Chair and advocate for education.", audience: "General Public, Media, Constituents", goal: "Introduce Rep. Johns; Highlight key legislative priorities." },
            { week: 1, date: '2025-07-01', channel: 'Facebook', theme: 'Introduction', title: "Meet Rep. Johns Video", description: "A short, engaging welcome message from Rep. Johns. He'll introduce himself, share a personal touch, and briefly touch on his passion for transportation and education.", audience: "All Constituents", goal: "Personal introduction; Build connection." },
            { week: 1, date: '2025-07-02', channel: 'Column', theme: 'Introduction', title: "Driving Progress, Educating Futures: A Message from Rep. Ronny Johns", description: "An in-depth introduction, a recap of the session's major achievements, with dedicated sections on his transportation leadership and education initiatives for HD 25.", audience: "All Constituents", goal: "Educate on achievements; Explain his dual focus." },
            { week: 1, date: '2025-07-03', channel: 'Facebook', theme: 'Introduction', title: "HD 25 Fact: Transportation & Education Impact", description: "High-impact graphic with concise facts about state investment in local roads or education, connecting it to HD 25, and a call for constituents to learn more.", audience: "All Constituents", goal: "Inform on state impact; Drive engagement." },
            { week: 1, date: '2025-07-04', channel: 'Facebook', theme: 'Community', title: "Happy Independence Day Message", description: "Patriotic message celebrating freedoms, perhaps a photo with local first responders or a community parade.", audience: "All Constituents", goal: "Express patriotism; Connect with values." },
            { week: 1, date: '2025-07-05', channel: 'Indigov', theme: 'Community', title: "Targeted Outreach: Welcome & Initialization", description: "1. Constituent Database Initialization. 2. Profiling & Tagging new constituents ('Transportation Interest', 'Education Advocate'). 3. Automated Welcome/Info Delivery.", audience: "New/Existing Constituents", goal: "Data collection; Initial welcome; Info provision." },
            { week: 2, date: '2025-07-07', channel: 'Facebook', theme: 'Transportation', title: "HD 25 Road Projects Update", description: "Post photos and a brief story about current or recently completed road/bridge projects in or near HD 25, highlighting their benefits to the community.", audience: "All Constituents, Commuters, Local Businesses", goal: "Inform on local infrastructure improvements." },
            { week: 2, date: '2025-07-10', channel: 'Facebook', theme: 'Transportation', title: "Ask Rep. Johns - Transportation Q&A", description: "Post a question about a common transportation issue in HD 25 (e.g., 'What local road issue is most important to you?'), then provide a clear, actionable answer/resource link or invite comments.", audience: "All Constituents, Commuters", goal: "Provide actionable info; Solicit engagement." },
            { week: 2, date: '2025-07-11', channel: 'Facebook', theme: 'Transportation', title: "Transportation Committee Insight", description: "Share a photo of Rep. Johns in a committee meeting or visiting a transportation site, with a caption about his ongoing work as Chair.", audience: "All Constituents, Engaged Citizens", goal: "Demonstrate active leadership in transportation." },
            { week: 2, date: '2025-07-12', channel: 'Indigov', theme: 'Transportation', title: "Targeted Outreach: Infrastructure Feedback", description: "1. Segmented Email Campaign to 'Transportation Interest' constituents. 2. Content: Share insights on local projects; invite feedback on specific road/bridge needs.", audience: "Commuters, Local Businesses, Concerned Residents", goal: "Solicit targeted feedback; Show ongoing commitment." },
            { week: 3, date: '2025-07-14', channel: 'Facebook', theme: 'Education', title: "Back-to-School Readiness Graphic", description: "Share a graphic with tips for parents and students preparing for the new school year (e.g., school supply checklists, early registration reminders).", audience: "Parents, Students, Educators", goal: "Provide practical back-to-school guidance." },
            { week: 3, date: '2025-07-15', channel: 'Facebook', theme: 'Education', title: "State Education Funding Video", description: "Short video: Rep. Johns discussing state efforts to support education funding for local schools in HD 25, and how it directly impacts students and teachers.", audience: "All Constituents, Parents, Educators", goal: "Inform on education funding; Demonstrate support." },
            { week: 3, date: '2025-07-16', channel: 'Column', theme: 'Education', title: "Investing in Our Children's Future: Education in HD 25", description: "Discuss the importance of state funding for local schools, teacher retention efforts, and programs supporting student success. Highlight how these investments prepare students for the future.", audience: "All Constituents, Parents, Educators", goal: "Inform on education priorities; Reassure on support." },
            { week: 3, date: '2025-07-17', channel: 'Facebook', theme: 'Education', title: "Support Local Schools Post", description: "Post a question like, 'What's one thing you appreciate most about our local schools in HD 25?' or 'How can we best support our teachers this school year?'", audience: "All Constituents, Parents, Educators", goal: "Encourage positive engagement; Solicit feedback." },
            { week: 3, date: '2025-07-18', channel: 'Facebook', theme: 'Education', title: "Education Fact Friday", description: "A quick, relatable fact about educational outcomes in Oklahoma or state investments in classroom technology.", audience: "All Constituents", goal: "Educate on positive impact of education investment." },
            { week: 4, date: '2025-07-21', channel: 'Facebook', theme: 'Transportation', title: "Safe Summer Driving Tips Graphic", description: "Graphic with reminders about safe driving practices during summer months (e.g., distracted driving, heat-related car issues, sharing the road with bikes/pedestrians).", audience: "All Constituents, Drivers", goal: "Promote road safety." },
            { week: 4, date: '2025-07-22', channel: 'Facebook', theme: 'Transportation', title: "Road Safety Message Video", description: "Short video from Rep. Johns focusing on a specific transportation safety issue, e.g., 'Keeping Our Roads Safe: A Message from Rep. Johns.' Discuss pedestrian safety or new traffic laws.", audience: "All Constituents, Commuters", goal: "Educate on specific safety issues; Show leadership." },
            { week: 4, date: '2025-07-25', channel: 'Facebook', theme: 'Community', title: "HD 25 Community Event Spotlight", description: "Post about an upcoming local community event (e.g., festival, farmers market) in HD 25, encouraging attendance and community spirit. Connect to ease of access via local transportation improvements.", audience: "All Constituents, Local Residents", goal: "Encourage local participation; Connect transport to community." },
            { week: 4, date: '2025-07-26', channel: 'Indigov', theme: 'Transportation', title: "Targeted Outreach: Safety & Resources", description: "1. General Email Campaign with a 'Road Safety Checklist'. 2. Content: Direct links to state/local transportation resources. 3. Localized Concern Collection: Create a 'Traffic Safety Concern' tag.", audience: "All Constituents, Commuters", goal: "Provide resources; Collect localized feedback." },
            { week: 5, date: '2025-07-28', channel: 'Facebook', theme: 'Education', title: "Career Tech & Higher Ed Opportunities Graphic", description: "Share a graphic highlighting various higher education institutions and career technology centers near HD 25, and how state support enables these opportunities.", audience: "Students, Parents, Job Seekers", goal: "Promote educational and vocational paths." },
            { week: 5, date: '2025-07-30', channel: 'Column', theme: 'Education', title: "Connecting Classrooms to Careers: Opportunities in Oklahoma", description: "Discuss the importance of vocational training and higher education for Oklahoma's workforce. Highlight state programs or scholarships that support students pursuing these paths.", audience: "Students, Parents, Job Seekers, Employers", goal: "Inform on workforce development; Provide resources." },
            { week: 5, date: '2025-07-31', channel: 'Facebook', theme: 'Education', title: "Student Success Story Video", description: "Post a short video spotlighting a local student from HD 25 who achieved success through a state-supported education or career tech program.", audience: "Students, Parents, Educators", goal: "Inspire and showcase positive outcomes." },
            { week: 5, date: '2025-08-01', channel: 'Facebook', theme: 'Education', title: "Workforce Development Fact Friday", description: "A fact about Oklahoma's growing industries or the economic impact of skilled labor.", audience: "All Constituents, Businesses", goal: "Educate on workforce importance." },
            { week: 6, date: '2025-08-04', channel: 'Facebook', theme: 'Community', title: "Inside the Transportation Committee Graphic", description: "Share an infographic explaining the role of the House Transportation Committee and Rep. Johns's position as Chair, using simple, relatable terms.", audience: "All Constituents, Engaged Citizens", goal: "Demystify legislative work; Highlight leadership." },
            { week: 6, date: '2025-08-07', channel: 'Facebook', theme: 'Community', title: "How a Bill Becomes Law (Simplified) Video", description: "Video of Rep. Johns providing a simplified explanation of the legislative process, focusing on how constituent input can influence legislation, especially in transportation or education.", audience: "All Constituents, Students, Engaged Citizens", goal: "Educate on legislative process; Encourage participation." },
            { week: 6, date: '2025-08-08', channel: 'Facebook', theme: "Community", title: "Legislative Insight Q&A", description: "Q&A: 'What's one question you have about how laws are made, or how I serve on the Transportation Committee?' Encourage questions and constructive dialogue.", audience: "All Constituents, Engaged Citizens", goal: "Solicit direct feedback on legislative process." },
            { week: 6, date: '2025-08-09', channel: 'Indigov', theme: 'Community', title: "Targeted Outreach: Civic Engagement", description: "1. Segmented Email Campaign to 'Civic Engagement' constituents. 2. Content: Direct links to legislative resources; invite feedback on transparency or ways to improve civic engagement.", audience: "Engaged Citizens, Students, Educators", goal: "Provide resources; Solicit specific feedback." },
            { week: 7, date: '2025-08-11', channel: 'Facebook', theme: 'Community', title: "HD 25 Community Hero Spotlight", description: "Feature a local individual or community group in HD 25 who has positively impacted the community, perhaps related to local infrastructure improvement or safe transportation advocacy (with permission).", audience: "All Constituents, Community Leaders", goal: "Recognize local contributions; Foster community pride." },
            { week: 7, date: '2025-08-13', channel: 'Column', theme: 'Transportation', title: "Driving Forward Together: Spotlight on HD 25 Progress", description: "Highlight specific, positive impacts of recent or ongoing state-funded transportation projects, featuring a constituent or local business success story related to improved infrastructure.", audience: "All Constituents, Local Businesses", goal: "Showcase local economy; Demonstrate support." },
            { week: 7, date: '2025-08-14', channel: 'Facebook', theme: 'Transportation', title: "Local Transportation Project Map/Overview", description: "Share a simple map or graphic showing current or planned transportation projects in HD 25, explaining their benefits and timelines (if publicly available).", audience: "All Constituents, Commuters", goal: "Inform on local project specifics." },
            { week: 7, date: '2025-08-15', channel: 'Facebook', theme: 'Transportation', title: "Local Impact Q&A", description: "Q&A: 'How have road improvements or transportation changes in HD 25 impacted your daily commute or local business?'", audience: "All Constituents, Local Commuters", goal: "Encourage local engagement; Solicit direct feedback." },
            { week: 8, date: '2025-08-18', channel: 'Facebook', theme: 'Education', title: "School Safety Tips Graphic", description: "Graphic: 'Back-to-School Safety Check!' (e.g., drop-off/pick-up safety, stranger awareness, emergency protocols).", audience: "Parents, Students, School Staff", goal: "Promote school safety awareness." },
            { week: 8, date: '2025-08-21', channel: 'Facebook', theme: 'Education', title: "Rep. Johns on School Safety Video", description: "Video of Rep. Johns discussing state initiatives and his commitment to ensuring safe learning environments in HD 25 schools. Might include a brief message from a local school official.", audience: "Parents, Educators, Community Members", goal: "Reassure on school safety; Highlight state support." },
            { week: 8, date: '2025-08-22', channel: 'Facebook', theme: 'Education', title: "School Resources Fact Friday", description: "A fact about state funding for school safety programs, or a link to mental health resources available for students and families.", audience: "Parents, Educators, Students", goal: "Provide actionable resources for safety/well-being." },
            { week: 8, date: '2025-08-23', channel: 'Indigov', theme: 'Education', title: "Targeted Outreach: School Safety", description: "1. Segmented Email Campaign to 'Education', 'Parents', or 'School Safety' constituents. 2. Content: Reference local school safety efforts; invite specific reports of school safety concerns.", audience: "Parents, Educators, School Staff", goal: "Solicit specific, localized issue reports." },
            { week: 9, date: '2025-08-25', channel: 'Facebook', theme: 'Transportation', title: "HD 25 Business Spotlight: Transportation & Growth", description: "Feature a local business in HD 25 that relies heavily on transportation (e.g., logistics, trucking, agricultural), highlighting how improved infrastructure benefits their operations.", audience: "Local Businesses, All Constituents", goal: "Recognize local contributions; Show support." },
            { week: 9, date: '2025-08-27', channel: 'Column', theme: 'Transportation', title: "Driving Prosperity: Transportation's Economic Impact in HD 25", description: "Discuss the critical role of transportation infrastructure in Oklahoma's economy and how Rep. Johns's work on the Transportation Committee directly contributes to job creation and business growth.", audience: "All Constituents, Local Businesses", goal: "Inform on economic development; Promote local commerce." },
            { week: 9, date: '2025-08-28', channel: 'Facebook', theme: 'Transportation', title: "State Economic Development Resources Video/Graphic", description: "Post a video or graphic about a state program that supports local businesses or attracts new industries, connecting it to improved transportation access.", audience: "Local Businesses, Entrepreneurs", goal: "Provide actionable resources for business growth." },
            { week: 9, date: '2025-08-29', channel: 'Facebook', theme: 'Transportation', title: "Local Economy Q&A", description: "Q&A: 'What opportunities do you see for economic growth in HD 25, especially related to our transportation network?'", audience: "All Constituents", goal: "Solicit direct feedback on economic issues." },
            { week: 10, date: '2025-09-01', channel: 'Facebook', theme: 'Community', title: "Happy Labor Day Message", description: "Acknowledging the workforce of Oklahoma, with a special mention of educators and those in transportation fields.", audience: "All Constituents", goal: "Connect with workforce values." },
            { week: 10, date: '2025-09-04', channel: 'Facebook', theme: 'Education', title: "Teacher Appreciation Post", description: "Graphic or video recognizing the hard work of teachers in HD 25. Rep. Johns could share a personal anecdote about a teacher who impacted him or highlight state initiatives supporting educators.", audience: "Parents, Students, Educators", goal: "Show gratitude and support for educators." },
            { week: 10, date: '2025-09-05', channel: 'Facebook', theme: 'Education', title: "Navigating Education-Related State Agencies Tips", description: "'Ask Rep. Johns - Education Resources': Post a common issue when dealing with an education-related state agency (e.g., 'Need information on school choice options?'), then provide clear steps and direct links.", audience: "Parents, Educators, Students", goal: "Provide actionable assistance; Show helpfulness." },
            { week: 10, date: '2025-09-06', channel: 'Indigov', theme: 'Education', title: "Targeted Outreach: Education Resources", description: "1. General Email blast to all constituents. 2. Content: Share actionable tips for navigating state education agencies. 3. Feedback Invitation: Encourage sharing experiences.", audience: "All Constituents, Parents, Educators", goal: "Provide practical help; Solicit feedback on efficiency." },
            { week: 11, date: '2025-09-08', channel: 'Facebook', theme: 'Transportation', title: "Innovation in Transportation Graphic", description: "'Did You Know?': A fact about emerging transportation technologies (e.g., autonomous vehicles, smart infrastructure) and Oklahoma's role in the future.", audience: "All Constituents, Tech Enthusiasts", goal: "Educate on future trends; Highlight state's role." },
            { week: 11, date: '2025-09-10', channel: 'Column', theme: 'Transportation', title: "Paving the Way Forward: The Future of Transportation & Education", description: "Discuss looking ahead in transportation infrastructure. Connect this to the need for education to prepare the next generation for these evolving fields. Highlight student opportunities in STEM.", audience: "All Constituents, Students, Educators, Innovators", goal: "Inform on future planning; Inspire career paths." },
            { week: 11, date: '2025-09-11', channel: 'Facebook', theme: 'Education', title: "Student Engagement Opportunity Video", description: "Short video of Rep. Johns encouraging students to consider careers in transportation, engineering, or other STEM fields related to infrastructure development.", audience: "Students, Parents, Educators", goal: "Encourage interest in relevant careers." },
            { week: 11, date: '2025-09-12', channel: 'Facebook', theme: 'Education', title: "Youth Civic & Education Program Spotlight", description: "Spotlight on upcoming legislative page programs, mock trial competitions, or other youth civic/educational leadership opportunities for high school students in HD 25.", audience: "Students, Parents, Educators", goal: "Inform on youth civic/education programs." },
            { week: 12, date: '2025-09-15', channel: 'Facebook', theme: 'Education', title: "HD 25 School Achievement Spotlight", description: "Feature a local school, team, or student group in HD 25 that recently achieved a notable accomplishment (e.g., academic award, sports victory, community service project).", audience: "All Constituents, Students, Parents, Educators", goal: "Celebrate local success; Foster community pride." },
            { week: 12, date: '2025-09-18', channel: 'Facebook', theme: 'Education', title: "Local School Visit Video", description: "Video of Rep. Johns visiting a local school in HD 25, interacting with students and teachers, emphasizing his commitment to education.", audience: "All Constituents, Parents, Educators", goal: "Demonstrate active engagement in schools." },
            { week: 12, date: '2025-09-19', channel: 'Facebook', theme: 'Education', title: "Fall Public Health Reminders for Schools", description: "Share an infographic or link from the Oklahoma State Department of Health on seasonal public health reminders relevant to schools (e.g., flu shots, hygiene tips).", audience: "Parents, Educators, School Staff", goal: "Inform on seasonal health; Provide resources for schools." },
            { week: 12, date: '2025-09-20', channel: 'Indigov', theme: 'Education', title: "Targeted Outreach: School Events & Health", description: "1. Localized Education Notification for upcoming school events. 2. Public Health Information email. 3. Feedback Invitation for local school news or health concerns.", audience: "All Constituents, Parents, Educators", goal: "Provide localized info; Solicit community input." },
            { week: 13, date: '2025-09-22', channel: 'Facebook', theme: 'Community', title: "Next Session Preview: Transportation & Education Graphic", description: "'Looking Ahead': Rep. Johns outlining 1-2 potential legislative priorities for the next session related to transportation or education.", audience: "All Constituents", goal: "Inform on future work; Set expectations." },
            { week: 13, date: '2025-09-24', channel: 'Column', theme: 'Community', title: "Your Voice for Next Session: Building Better Roads & Schools", description: "Discuss how constituent feedback shapes upcoming legislation. Specifically invite input on future transportation projects or educational improvements that are important to HD 25.", audience: "All Constituents", goal: "Solicit input for next session; Empower constituents." },
            { week: 13, date: '2025-09-25', channel: 'Facebook', theme: 'Community', title: "Legislative Ideas Solicitation Video", description: "Video of Rep. Johns directly soliciting ideas for legislative priorities from constituents for the upcoming session, with a focus on transportation and education.", audience: "All Constituents", goal: "Encourage direct input on legislation." },
            { week: 13, date: '2025-09-26', channel: 'Facebook', theme: 'Community', title: "Legislative Process Fact Friday: Committee Work", description: "A fact about the importance of committee work in the legislative process, emphasizing the Transportation Committee's role.", audience: "All Constituents", goal: "Educate on legislative process; Highlight committee role." },
            { week: 14, date: '2025-09-29', channel: 'Facebook', theme: 'Community', title: "Q3 Accomplishments Graphic: Roads & Schools", description: "Graphic highlighting key accomplishments or constituent engagements from July-September, specifically emphasizing transportation and education efforts.", audience: "All Constituents", goal: "Summarize Q3 achievements; Show progress." },
            { week: 14, date: '2025-10-02', channel: 'Facebook', theme: 'Community', title: "Thank You Q3 & Look Ahead Video", description: "Video of Rep. Johns thanking constituents for their engagement in Q3 and looking forward to continued work in Q4, briefly mentioning any upcoming town halls or events.", audience: "All Constituents", goal: "Express gratitude; Set expectations for Q4." },
            { week: 14, date: '2025-10-03', channel: 'Facebook', theme: 'Community', title: "Q4 Focus Q&A: Your Priorities", description: "Q&A: 'As we look towards the end of the year, what transportation or education issues should Rep. Johns focus on for HD 25?'", audience: "All Constituents", goal: "Solicit forward-looking feedback; Maintain engagement." },
            { week: 14, date: '2025-10-04', channel: 'Indigov', theme: 'Community', title: "Targeted Outreach: Q3 Recap & Feedback", description: "1. Q3 Recap Email summarizing highlights. 2. Future Focus & Feedback invitation. 3. Newsletter Sign-up Reminder.", audience: "All Constituents, Engaged Voters", goal: "Summarize Q3; Solicit future input; Drive newsletter sign-ups." },
        ];


        function getChannelIcon(channel) {
            switch (channel) {
                case 'Facebook': return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-blue-600"><path d="M18 2h-3a5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>`;
                case 'Column': return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-amber-600"><path d="M12 22h6a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h6Z"/><path d="M12 2v20"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h.5"/><path d="M17 12H9.5a3.5 3.5 0 0 0 0 7h.5"/></svg>`;
                case 'Press Release': return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-teal-600"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2V6"/><path d="m9 18 3-3 3 3"/><path d="m9 12 3-3 3 3"/><path d="m9 6 3-3 3 3"/></svg>`;
                case 'Indigov': return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-indigo-600"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`;
                default: return '';
            }
        }

        // Function to update item properties (for link, status, graphicNeeded)
        async function updateItemProperty(event, itemId, property) {
            // Retrieve appId from the data attribute set in setupFirestoreListener
            const currentAppId = document.documentElement.dataset.appId || 'default-app-id'; 
            if (!window.isAuthReady || !window.db || !window.currentUserId) {
                console.warn("Firestore not ready. Cannot update item.");
                showAppMessage("Firestore is not ready. Please wait or refresh.", "error");
                return;
            }

            const itemIndex = outreachData.findIndex(d => d.id === itemId);
            if (itemIndex === -1) return;

            const item = { ...outreachData[itemIndex] }; // Create a shallow copy

            try {
                if (property === 'graphicNeeded') {
                    item[property] = event.target.checked;
                } else if (property === 'date') {
                    const newDate = event.target.value;
                    if (!isNaN(new Date(newDate))) {
                        item[property] = newDate;
                    } else {
                        showAppMessage('Invalid date format. Please use YYYY-MM-DD.', "error");
                        event.target.value = item[property]; // Revert to old value in UI
                        return;
                    }
                } else {
                    item[property] = event.target.value;
                }

                // Update Firestore
                const docRef = window.firestoreDoc(window.db, `artifacts/${currentAppId}/users/${window.currentUserId}/outreachItems`, itemId);
                await window.firestoreUpdateDoc(docRef, { [property]: item[property] });
                
                showAppMessage("Item updated successfully!", "success");
            } catch (error) {
                console.error("Error updating document:", error);
                showAppMessage(`Failed to update item: ${error.message}`, "error");
            }
        }

        // Function to update contenteditable fields (title, description, audience, goal)
        async function updateEditableContent(event, itemId, property) {
            // Retrieve appId from the data attribute set in setupFirestoreListener
            const currentAppId = document.documentElement.dataset.appId || 'default-app-id'; 
            if (!window.isAuthReady || !window.db || !window.currentUserId) {
                console.warn("Firestore not ready. Cannot update item.");
                showAppMessage("Firestore is not ready. Please wait or refresh.", "error");
                return;
            }

            const itemIndex = outreachData.findIndex(d => d.id === itemId);
            if (itemIndex === -1) return;

            const newValue = event.target.innerText;
            if (outreachData[itemIndex][property] === newValue) {
                // No change, prevent unnecessary write
                return;
            }

            try {
                // Update Firestore
                const docRef = window.firestoreDoc(window.db, `artifacts/${currentAppId}/users/${window.currentUserId}/outreachItems`, itemId);
                await window.firestoreUpdateDoc(docRef, { [property]: newValue });
                
                showAppMessage("Content updated successfully!", "success");
            } catch (error) {
                console.error("Error updating document:", error);
                showAppMessage(`Failed to update content: ${error.message}`, "error");
            }
        }

        // Function to delete an item
        function deleteItem(itemId) {
            // Retrieve appId from the data attribute set in setupFirestoreListener
            const currentAppId = document.documentElement.dataset.appId || 'default-app-id'; 
            if (!window.isAuthReady || !window.db || !window.currentUserId) {
                console.warn("Firestore not ready. Cannot delete item.");
                showAppMessage("Firestore is not ready. Please wait or refresh.", "error");
                return;
            }

            showConfirmModal('Are you sure you want to delete this outreach activity? This action cannot be undone.', async () => {
                try {
                    const docRef = window.firestoreDoc(window.db, `artifacts/${currentAppId}/users/${window.currentUserId}/outreachItems`, itemId);
                    await window.firestoreDeleteDoc(docRef);
                    showAppMessage("Item deleted successfully!", "success");
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showAppMessage(`Failed to delete item: ${error.message}`, "error");
                }
            });
        }

        // --- Firestore Data Setup and Listening ---
        // setupFirestoreListener now takes appId as an argument
        async function setupFirestoreListener(appId) { 
            if (!window.db || !window.currentUserId) {
                console.warn("Firestore or User ID not available for listener setup.");
                return;
            }

            // Store appId in a data attribute on html element for global access in functions outside DOMContentLoaded
            // This is safer than relying on a global variable that might be overwritten or not initialized in time.
            document.documentElement.dataset.appId = appId;

            userIdDisplay.textContent = `User ID: ${window.currentUserId}`;
            loadingIndicator.classList.remove('hidden');

            const outreachCollectionRef = window.firestoreCollection(window.db, `artifacts/${appId}/users/${window.currentUserId}/outreachItems`);
            
            // Check if collection is empty and seed initial data if needed
            const snapshot = await window.firestoreGetDocs(outreachCollectionRef);
            if (snapshot.empty) {
                console.log("Collection is empty. Seeding initial data.");
                showAppMessage("First-time setup: Populating initial data...", "info", 5000);
                for (const item of initialRawOutreachData) {
                    const newItem = { ...item, id: crypto.randomUUID(), link: '', status: 'Planned', graphicNeeded: false };
                     // Adjust column dates to Sundays (logic from previous version)
                    if (newItem.channel === 'Column') {
                        const originalDate = new Date(newItem.date);
                        const dayOfWeek = originalDate.getDay(); // 0 for Sunday, 1 for Monday, etc.
                        const diff = 0 - dayOfWeek; 
                        originalDate.setDate(originalDate.getDate() + diff);
                        newItem.date = originalDate.toISOString().split('T')[0]; 
                    }
                    try {
                        // Use setDoc with the ID to ensure consistent IDs and prevent duplicates on re-seed attempts
                        await window.firestoreSetDoc(window.firestoreDoc(outreachCollectionRef, newItem.id), newItem);
                    } catch (e) {
                        console.error("Error adding initial document: ", e);
                        showAppMessage(`Error seeding data: ${e.message}`, "error");
                    }
                }
            }

            // Listen for real-time updates
            window.firestoreOnSnapshot(outreachCollectionRef, (snapshot) => {
                outreachData = []; // Clear current data
                snapshot.forEach(doc => {
                    outreachData.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort data by date after fetching
                outreachData.sort((a, b) => new Date(a.date) - new Date(b.date));

                console.log("Data fetched/updated from Firestore. Total items:", outreachData.length);
                renderCalendarGrid();
                renderKPIs();
                renderCharts();
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showAppMessage(`Error loading data: ${error.message}`, "error");
                loadingIndicator.classList.add('hidden');
            });

            // Initialize filters UI after initial data load
            setupFilters();
        }

        // --- Existing UI Rendering and Filter Functions (moved outside DOMContentLoaded for clarity) ---

        function renderCalendarGrid() {
            calendarGrid.innerHTML = '';
            const filteredData = outreachData.filter(item => {
                const weekMatch = filters.week === 'all' || item.week == filters.week;
                const channelMatch = filters.channel === 'all' || item.channel === filters.channel;
                
                let themeMatch = filters.theme === 'all';
                if (filters.theme === 'Transportation') themeMatch = item.theme === 'Transportation';
                if (filters.theme === 'Education') themeMatch = item.theme === 'Education';
                if (filters.theme === 'Community') themeMatch = ['Community', 'Introduction'].includes(item.theme);

                const statusMatch = filters.status === 'all' || item.status === filters.status;
                const graphicMatch = filters.graphic === 'all' || 
                                     (filters.graphic === 'yes' && item.graphicNeeded) || 
                                     (filters.graphic === 'no' && !item.graphicNeeded);

                return weekMatch && channelMatch && themeMatch && statusMatch && graphicMatch;
            });

            if (filteredData.length === 0) {
                calendarGrid.innerHTML = `<p class="md:col-span-2 text-center text-slate-500">No activities match the current filters.</p>`;
                return;
            }

            filteredData.forEach((item, index) => {
                const card = document.createElement('div');
                let cardClasses = 'bg-white p-5 rounded-xl shadow-sm border border-slate-100 card-enter relative'; 
                if (item.graphicNeeded) {
                    cardClasses += ' graphic-needed-highlight';
                }
                card.className = cardClasses;
                card.style.animationDelay = `${index * 30}ms`;

                card.innerHTML = `
                    <div class="flex items-center text-sm font-semibold text-slate-600 mb-3">
                        ${getChannelIcon(item.channel)}
                        <span>${item.channel}</span>
                        <span class="mx-2"></span>
                        <input type="date" value="${item.date}" class="p-1 border border-slate-300 rounded-md bg-slate-50 focus:ring-1 focus:ring-blue-500 text-sm" onchange="updateItemProperty(event, '${item.id}', 'date')">
                        <span class="ml-auto text-xs font-bold px-2 py-1 rounded-full 
                            ${item.status === 'Completed' ? 'bg-green-100 text-green-700' :
                               item.status === 'Scheduled' ? 'bg-yellow-100 text-yellow-700' :
                               'bg-blue-100 text-blue-700'}">
                            ${item.status}
                        </span>
                    </div>
                    <h4 class="font-bold text-md text-slate-800 mb-2 editable-text-field" contenteditable="true" onblur="updateEditableContent(event, '${item.id}', 'title')">${item.title}</h4>
                    <p class="text-sm text-slate-600 mb-4 editable-text-field" contenteditable="true" onblur="updateEditableContent(event, '${item.id}', 'description')">${item.description}</p>
                    
                    <div class="mb-4">
                        <label for="link-${item.id}" class="block text-xs font-medium text-slate-500 mb-1">Content Link</label>
                        <input type="url" id="link-${item.id}" value="${item.link}" placeholder="https://example.com/content" class="w-full p-2 text-sm border border-slate-300 rounded-md bg-slate-50 focus:ring-1 focus:ring-blue-500" onchange="updateItemProperty(event, '${item.id}', 'link')">
                    </div>
                    <div class="mb-4">
                        <label for="status-${item.id}" class="block text-xs font-medium text-slate-500 mb-1">Status</label>
                        <select id="status-${item.id}" class="w-full p-2 text-sm border border-slate-300 rounded-md bg-slate-50 focus:ring-1 focus:ring-blue-500" onchange="updateItemProperty(event, '${item.id}', 'status')">
                            <option value="Planned" ${item.status === 'Planned' ? 'selected' : ''}>Planned</option>
                            <option value="Scheduled" ${item.status === 'Scheduled' ? 'selected' : ''}>Scheduled</option>
                            <option value="Completed" ${item.status === 'Completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                    <div class="checkbox-container text-sm text-slate-600 mb-4">
                        <input type="checkbox" id="graphic-${item.id}" ${item.graphicNeeded ? 'checked' : ''} onchange="updateItemProperty(event, '${item.id}', 'graphicNeeded')">
                        <label for="graphic-${item.id}" class="cursor-pointer">Graphic/Image Needed</label>
                    </div>

                    <div class="text-xs space-y-2 text-slate-500 mt-4 pt-4 border-t border-slate-100">
                       <p><strong class="font-medium text-slate-600">Audience:</strong> <span class="editable-text-field" contenteditable="true" onblur="updateEditableContent(event, '${item.id}', 'audience')">${item.audience}</span></p>
                       <p><strong class="font-medium text-slate-600">Goal:</strong> <span class="editable-text-field" contenteditable="true" onblur="updateEditableContent(event, '${item.id}', 'goal')">${item.goal}</span></p>
                    </div>
                    <div class="flex justify-end mt-4"> 
                        <button class="text-red-500 hover:text-red-700 p-1 rounded-full bg-slate-50 hover:bg-red-100 transition-colors" onclick="deleteItem('${item.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                        </button>
                    </div>
                `;
                calendarGrid.appendChild(card);
            });
        }

        function setupFilters() {
            // Only populate week filter if data is available
            if (outreachData.length > 0) {
                const totalWeeks = Math.max(...outreachData.map(item => item.week));
                weekFilter.innerHTML = '<option value="all">All Weeks</option>'; // Reset options
                for (let i = 1; i <= totalWeeks; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Week ${i}`;
                    weekFilter.appendChild(option);
                }
            } else {
                weekFilter.innerHTML = '<option value="all">All Weeks</option>'; // Keep default if no data
            }

            weekFilter.onchange = (e) => {
                filters.week = e.target.value;
                renderCalendarGrid();
            };

            channelFilters.onclick = (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const currentActive = channelFilters.querySelector('.active');
                    if (currentActive) {
                        currentActive.classList.remove('active');
                    }
                    e.target.classList.add('active');
                    filters.channel = e.target.dataset.filter;
                    renderCalendarGrid();
                }
            };

            themeFilters.onclick = (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const currentActive = themeFilters.querySelector('.active');
                    if (currentActive) {
                        currentActive.classList.remove('active');
                    }
                    e.target.classList.add('active');
                    filters.theme = e.target.dataset.filter;
                    renderCalendarGrid();
                }
            };

            statusFilters.onclick = (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const currentActive = statusFilters.querySelector('.active');
                    if (currentActive) {
                        currentActive.classList.remove('active');
                    }
                    e.target.classList.add('active');
                    filters.status = e.target.dataset.filter;
                    renderCalendarGrid();
                }
            };

            graphicFilters.onclick = (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const currentActive = graphicFilters.querySelector('.active');
                    if (currentActive) {
                        currentActive.classList.remove('active');
                    }
                    e.target.classList.add('active');
                    filters.graphic = e.target.dataset.filter;
                    renderCalendarGrid();
                }
            };
        }
        
        function renderKPIs() {
            const totalActivities = outreachData.length;
            const channelCounts = outreachData.reduce((acc, item) => {
                acc[item.channel] = (acc[item.channel] || 0) + 1;
                return acc;
            }, {});
            const totalColumns = channelCounts['Column'] || 0;
            const totalPressReleases = channelCounts['Press Release'] || 0;

            const kpis = [
                { label: 'Total Activities', value: totalActivities, icon: '' },
                { label: 'Facebook Posts', value: channelCounts['Facebook'] || 0, icon: '' },
                { label: 'Newspaper Columns', value: totalColumns, icon: '' },
                { label: 'Indigov Campaigns', value: channelCounts['Indigov'] || 0, icon: '' }
            ];

            kpiSection.innerHTML = kpis.map(kpi => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="text-3xl font-bold text-blue-800">${kpi.value}</div>
                    <div class="text-sm text-slate-600 mt-1">${kpi.label}</div>
                </div>
            `).join('');
        }

        let channelChartInstance = null;
        let weeklyActivityChartInstance = null;

        function renderCharts() {
            const channelCounts = outreachData.reduce((acc, item) => {
                acc[item.channel] = (acc[item.channel] || 0) + 1;
                return acc;
            }, {});
            const channelLabels = Object.keys(channelCounts);
            const channelData = Object.values(channelCounts);

            if (channelChartInstance) {
                channelChartInstance.destroy();
            }
            channelChartInstance = new Chart(document.getElementById('channelChart'), {
                type: 'doughnut',
                data: {
                    labels: channelLabels,
                    datasets: [{
                        label: 'Activities by Channel',
                        data: channelData,
                        backgroundColor: ['#3B82F6', '#F59E0B', '#10B981', '#6366F1'],
                        borderColor: '#FDFBF7',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: "'Inter', sans-serif" }
                            }
                        }
                    }
                }
            });

            const weeklyCounts = {};
            outreachData.forEach(item => {
                weeklyCounts[item.week] = (weeklyCounts[item.week] || 0) + 1;
            });
            // Ensure all weeks are represented even if they have no activities
            const allWeeks = Array.from({length: Math.max(...outreachData.map(d => d.week), 0)}, (_, i) => i + 1);
            const weeklyLabels = allWeeks.map(w => `Week ${w}`);
            const weeklyData = allWeeks.map(w => weeklyCounts[w] || 0);


            if (weeklyActivityChartInstance) {
                weeklyActivityChartInstance.destroy();
            }
            weeklyActivityChartInstance = new Chart(document.getElementById('weeklyActivityChart'), {
                type: 'bar',
                data: {
                    labels: weeklyLabels,
                    datasets: [{
                        label: 'Activities per Week',
                        data: weeklyData,
                        backgroundColor: '#3B82F6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Make functions globally accessible for inline event handlers
        window.updateItemProperty = updateItemProperty;
        window.updateEditableContent = updateEditableContent;
        window.deleteItem = deleteItem;
        window.showAppMessage = showAppMessage; // For custom app messages if needed elsewhere
        window.showConfirmModal = showConfirmModal; // For custom confirmation modal

    </script>

</body>
</html>